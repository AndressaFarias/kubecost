https://github.com/kubecost/docs/blob/master/aws-cloud-integrations.md

O Kubecost extrai os preÃ§os dos ativos da API pÃºblica de preÃ§os da AWS por padrÃ£o. Para ter informaÃ§Ãµes de preÃ§os precisas da AWS, vocÃª pode integrar diretamente Ã  sua conta. Essa integraÃ§Ã£o considerarÃ¡ adequadamente os Programas de descontos corporativos, o uso de instÃ¢ncias reservadas, os Savings Plans, o uso spot e muito mais.Este roteiro descreve as etapas necessÃ¡rias para alcanÃ§ar isso.

Seu usuÃ¡rio precisarÃ¡ das permissÃµes necessÃ¡rias para criar o relatÃ³rio de custo e uso (Cost and Usage Report), adicionar credenciais do IAM para Athena e S3. A permissÃ£o opcional Ã© a capacidade de adicionar e executar modelos do CloudFormation
# Cost and Usage Report Integration

## Step 1: Setting up the CUR
(Passo 1: Configurando o CUR (Cost and Usage Report))

Siga estas etapas para configurar um relatÃ³rio de custo e uso. Certifique-se de habilitar a integraÃ§Ã£o de IDs de recursos e Athena ao criar o CUR. 

ğŸ“Œ Anote o nome do bucket que vocÃª cria para dados CUR. Isso serÃ¡ usado na etapa seguinte.

ğŸ“Œ Se vocÃª acredita que tem as permissÃµes corretas, mas nÃ£o consegue acessar a pÃ¡gina Billing and Cost Management, peÃ§a ao proprietÃ¡rio da conta raiz da sua organizaÃ§Ã£o para seguir estas instruÃ§Ãµes https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/control-access-billing.html

A AWS pode levar vÃ¡rias horas para publicar os dados, espere atÃ© que isso seja concluÃ­do antes de prosseguir para a prÃ³xima etapa

### [Creating Cost and Usage Reports](
https://docs.aws.amazon.com/cur/latest/userguide/cur-create.html)

VocÃª pode usar a pÃ¡gina Cost & Usage Reports do console Billing and Cost Management para criar RelatÃ³rios Cost and Usage.

ğŸ“Œ Pode levar atÃ© 24 horas para que a AWS comece a entregar relatÃ³rios ao seu bucket do Amazon S3. ApÃ³s o inÃ­cio da entrega, a AWS atualiza os arquivos de relatÃ³rios de uso e custo da AWS pelo menos uma vez por dia.

#### Criar relatÃ³rios Cost and Usage
[Creating Cost and Usage Reports
](https://docs.aws.amazon.com/cur/latest/userguide/cur-create.html)

1. FaÃ§a login no console do Billing and Cost Management em https://console.aws.amazon.com/billing/home#/

2. No painel de navegaÃ§Ã£o, selecione Cost and Usage Report.

3. Escolha Create report (Criar relatÃ³rio).

4. Em Report name (Nome do relatÃ³rio), insira um nome para o relatÃ³rio

>>    Nome do relatÃ³rio =  aws-cost-report
    
ğŸ“Œ O nome do relatÃ³rio deve ser Ãºnico e conter apenas caracteres alfanumÃ©ricos! - _ . * '( )

5. Em _Additional report details_ (Detalhes adicionais do relatÃ³rio), selecione Include resource IDs (Incluir IDs de recurso) para incluir os IDs de cada recurso individual no relatÃ³rio.

A inclusÃ£o de IDs de recursos criarÃ¡ itens de linha individuais para cada um de seus recursos. Isso pode aumentar significativamente o tamanho dos seus arquivos de RelatÃ³rios de custos e uso, com base noAWSuso do.

>> seleciona a caixa

ğŸ“Œ Pode levar atÃ© 24 horas porAWSPara comeÃ§ar a entregar relatÃ³rios no bucket do Amazon S3. ApÃ³s o inÃ­cio da entrega,AWSatualiza oAWSRelatÃ³rios de custos e uso pelo menos uma vez por dia.

ğŸ“Œ Quando os recursos sÃ£o criados, a AWS atribui um ID de recurso exclusivo a cada um deles. Incluir IDs de recursos individuais em seu relatÃ³rio pode aumentar significativamente o tamanho do arquivo.


6. Para Data refresh settings (configuraÃ§Ãµes de atualizaÃ§Ã£o de dados), selecione se deseja que os relatÃ³rios de uso e custo da AWS sejam atualizados se a AWS aplicar reembolsos, crÃ©ditos ou taxas de suporte Ã  sua conta apÃ³s finalizar sua fatura. Quando um relatÃ³rio Ã© atualizado, um novo relatÃ³rio Ã© carregado no Amazon S3.

ğŸ“Œ Muitas vezes, essas cobranÃ§as estÃ£o relacionadas com reembolsos, crÃ©ditos e taxas do AWS Support.

ğŸ“Œ  Selecionar essa opÃ§Ã£o atualiza automaticamente seu RelatÃ³rio de uso e custos quando forem detectadas cobranÃ§as de meses anteriores com faturas fechadas

>> selecionar a caixa

7. AvanÃ§ar.

8. Para bucket do S3, escolha Configure.
    
    ğŸ“Œ Para receber os relatÃ³rios de uso e custo da AWS, vocÃª deve ter um bucket do Amazon S3 criado e configurado com as permissÃµes de acesso apropriadas. VocÃª pode adicionar um bucket existente ou criar um novo.

 9. Create a bucket / selecione o bucket
       * S3 bucket name = kubecost-aws-cost-and-usage-report
       * Region = US East (N. Virginia)

       ğŸ“Œ Se vocÃª criar um bucket para relatÃ³rios de custo e uso da AWS, as configuraÃ§Ãµes e permissÃµes padrÃ£o serÃ£o aplicadas. ApÃ³s a criaÃ§Ã£o do bucket, vocÃª pode atualizar as configuraÃ§Ãµes e permissÃµes no console do Amazon S3.

       ğŸ“Œ Algumas regiÃµes sÃ£o desabilitadas por padrÃ£o. Para criar um bucket em uma dessas regiÃµes, vocÃª deve habilitar a regiÃ£o primeiro. Saber mais


10. Revise a polÃ­tica do bucket e selecione I have confirmed that this policy (Confirmei que esta polÃ­tica estÃ¡ correta) e escolha Salvar.

    Politica padrÃ£o aplicada

    ~~~json
    {
  "Version": "2008-10-17",
  "Id": "Policy1335892530063",
  "Statement": [
    {
      "Sid": "Stmt1335892150622",
      "Effect": "Allow",
      "Principal": {
        "Service": "billingreports.amazonaws.com"
      },
      "Action": [
        "s3:GetBucketAcl",
        "s3:GetBucketPolicy"
      ],
      "Resource": "arn:aws:s3:::kubecost-aws-cost-and-usage-report",
      "Condition": {
        "StringEquals": {
          "aws:SourceArn": "arn:aws:cur:us-east-1:701893420597:definition/*",
          "aws:SourceAccount": "701893420597"
        }
      }
    },
    {
      "Sid": "Stmt1335892526596",
      "Effect": "Allow",
      "Principal": {
        "Service": "billingreports.amazonaws.com"
      },
      "Action": [
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::kubecost-aws-cost-and-usage-report/*",
      "Condition": {
        "StringEquals": {
          "aws:SourceArn": "arn:aws:cur:us-east-1:701893420597:definition/*",
          "aws:SourceAccount": "701893420597"
        }
      }
    }
  ]
}
    ~~~

11. Para _Report path prefix_ (Prefixo do caminho do relatÃ³rio), insira o prefixo do caminho do relatÃ³rio que deseja anexar ao nome do seu relatÃ³rio.

https://docs.aws.amazon.com/enterprisebilling/6b7c01c5-b592-467e-9769-90052eaf359c/userguide/configuring-eb.html

Valor informado : 

>>  Report path prefix - required = costusage

12. >> Time granularity : Daily

    ğŸ“Œ A granularidade de tempo na qual os dados do relatÃ³rio sÃ£o medidos e exibidos.

    ğŸ“Œ Daily:  se desejar que os itens de linha no relatÃ³rio sejam agregados por dia.

13. Para Report versioning (VersÃ£o de relatÃ³rio), escolha se deseja que cada versÃ£o do relatÃ³rio sobrescreva a versÃ£o anterior do relatÃ³rio ou seja entregue alÃ©m das versÃµes anteriores. 

A substituiÃ§Ã£o de relatÃ³rios pode economizar nos custos de armazenamento do Amazon S3. A entrega de novas versÃµes de relatÃ³rios pode melhorar a capacidade de auditoria dos dados de faturamento ao longo do tempo.

>> Report versioning = Create new report version X 
>> Utilizando o Athena Ã© selecionado por padrÃ£o Overwrite existing report, sme a possibilidade de allterar a opÃ§Ã£o


14. Em Enable report data integration for (Habilitar integraÃ§Ã£o de dados de relatÃ³rio para), selecione se deseja habilitar seus relatÃ³rios de custo e uso para integraÃ§Ã£o com Amazon Athena, Amazon Redshift ou Amazon QuickSight. O relatÃ³rio Ã© compactado nos seguintes formatos:
 * Athena: formato parquet
 * Amazon Redshift ou Amazon QuickSight: compactaÃ§Ã£o .gz


>> Enable report data integration for = Amazon Athena


15. AvanÃ§ar.


16. Depois de revisar as configuraÃ§Ãµes do seu relatÃ³rio, escolha Revisar e concluir.



VocÃª sempre pode retornar Ã  seÃ§Ã£o RelatÃ³rios de custo e uso do console do Billing and Cost Management para ver quando seus relatÃ³rios foram atualizados pela Ãºltima vez.



## Step 2: Setting up Athena
(Passo 2: Configurando o Athena)

https://docs.aws.amazon.com/cur/latest/userguide/cur-ate-setup.html#create-athena-cur


ğŸ“• O que sÃ£o os relatÃ³rios de uso e custo da AWS?
[What are AWS Cost and Usage Reports?](https://docs.aws.amazon.com/cur/latest/userguide/what-is-cur.html) 


ğŸ“Œ Clique no prÃ³ximo link PrÃ³ximo tÃ³pico para obter instruÃ§Ãµes passo a passo sobre como configurar o Athena por meio do cloud formation

1. Navegue atÃ© https://console.aws.amazon.com/s3
2. 


